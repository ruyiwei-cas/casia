<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中科院自动化所（矿山垂类大模型）</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <style>
        /* 样式保持不变，这里省略 */
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        :root {
            --primary-color: #0050e0;
            --primary-light: #e5edff;
            --secondary-color: #00b0ff;
            --accent-color: #00eaff;
            --dark-bg: #001428;
            --light-bg: #f5f9ff;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #999999;
            --border-color: #e0e9ff;
            --shadow-color: rgba(0, 80, 224, 0.12);
            --gradient-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-accent: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            --glow-effect: 0 0 20px rgba(0, 80, 224, 0.25);
            --mining-color-1: #ffb100;
            --mining-color-2: #ff5630;
            --user-msg-bg: var(--primary-light);
            --assistant-msg-bg: var(--card-bg);
            --loading-bg: rgba(0, 80, 224, 0.1);
            --code-bg: #f6f8fa;
            --code-border: #dfe5ed;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* 主容器 */
        .container {
            display: flex;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        /* 科技背景装饰 */
        .tech-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.05;
            z-index: 0;
            overflow: hidden;
        }
        
        .tech-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, rgba(0, 80, 224, 0.08) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 80, 224, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
        }
        
        .tech-line {
            position: absolute;
            background: var(--primary-color);
            opacity: 0.3;
        }
        
        .tech-circle {
            position: absolute;
            border: 1px solid var(--primary-color);
            border-radius: 50%;
            opacity: 0.15;
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 80px;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 25px;
            color: white;
            position: relative;
            z-index: 10;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.15);
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0, 80, 224, 0.3), transparent 70%);
            z-index: -1;
        }
        
        .sidebar-item {
            width: 100%;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .sidebar-item i {
            font-size: 26px;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }
        
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            height: 60%;
            width: 4px;
            background: var(--accent-color);
            border-radius: 0 3px 3px 0;
            box-shadow: 0 0 10px rgba(0, 234, 255, 0.6);
        }
        
        .sidebar-item:hover i {
            transform: translateY(-3px);
            color: var(--accent-color);
        }
        
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* 首页按钮 */
        .home-button {
            width: 100%;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 25px;
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .home-button i {
            font-size: 28px;
            margin-bottom: 6px;
            transition: all 0.3s ease;
            color: white;
        }
        
        .home-button:hover i {
            transform: translateY(-3px);
            color: var(--accent-color);
        }
        
        .home-button::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20%;
            width: 60%;
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            background-color: var(--card-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 5;
            box-shadow: 0 0 25px var(--shadow-color);
        }
        
        /* 头部栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }
        
        .title-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            height: 45px;
            margin-right: 15px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            position: relative;
            letter-spacing: 0.5px;
        }
        
        .title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: var(--gradient-bg);
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0, 80, 224, 0.3);
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--light-bg);
            border-radius: 24px;
            padding: 8px 18px;
            width: 320px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
        }
        
        .search-box:hover, .search-box:focus-within {
            box-shadow: var(--glow-effect);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .search-box input {
            border: none;
            outline: none;
            background: transparent;
            padding: 8px;
            width: 100%;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .search-box i {
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .user-options {
            display: flex;
            align-items: center;
        }
        
        .header-icon {
            margin-right: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .header-icon:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* 聊天部分 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 35px 100px;
            overflow-y: auto;
            background-color: var(--light-bg);
            position: relative;
            background-image: radial-gradient(circle at 10% 90%, rgba(0, 80, 224, 0.03) 0%, transparent 60%),
                             radial-gradient(circle at 90% 10%, rgba(0, 234, 255, 0.03) 0%, transparent 60%);
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeIn 0.9s ease-out;
            position: relative;
        }
        
        .welcome-section.hidden {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-section::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(0, 80, 224, 0.05) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            z-index: -1;
        }
        
        .bot-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--gradient-bg);
            color: white;
            font-size: 38px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: var(--glow-effect), inset 0 2px 10px rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }
        
        .bot-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            animation: shineEffect 5s infinite;
        }
        
        @keyframes shineEffect {
            0% { transform: translateX(-100%) rotate(45deg); }
            40%, 100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .welcome-text {
            margin-bottom: 15px;
            font-size: 17px;
            color: var(--text-secondary);
            max-width: 650px;
            margin: 0 auto 25px;
            line-height: 1.7;
        }
        
        .welcome-section h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 28px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .action-links {
            margin-top: 15px;
            font-size: 15px;
            color: var(--primary-color);
        }
        
        .action-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin-left: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 6px 12px;
            border-radius: 6px;
            position: relative;
        }
        
        .action-links a:hover {
            background-color: var(--primary-light);
            box-shadow: 0 3px 8px rgba(0, 80, 224, 0.15);
            transform: translateY(-1px);
        }
        
        .action-links a.more-link::after {
            content: '»';
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        
        .action-links a.more-link:hover::after {
            margin-left: 8px;
        }
        
        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin-top: 35px;
            perspective: 1000px;
        }
        
        .suggestion-card {
            background-color: var(--card-bg);
            border-radius: 14px;
            padding: 24px 28px;
            width: 45%;
            min-width: 350px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            animation: fadeInUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            animation-delay: calc(var(--index) * 0.15s);
            opacity: 0;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(25px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .suggestion-card:nth-child(1) { --index: 1; }
        .suggestion-card:nth-child(2) { --index: 2; }
        .suggestion-card:nth-child(3) { --index: 3; }
        .suggestion-card:nth-child(4) { --index: 4; }
        
        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient-bg);
            border-radius: 4px 0 0 4px;
            opacity: 0.85;
            transition: all 0.3s ease;
        }
        
        .suggestion-card:nth-child(odd)::before {
            background: var(--gradient-bg);
        }
        
        .suggestion-card:nth-child(even)::before {
            background: var(--gradient-accent);
        }
        
        .suggestion-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 40%;
            background: linear-gradient(to left, rgba(255, 255, 255, 0.9), transparent);
            opacity: 0;
            transition: all 0.4s ease;
            transform: translateX(100%);
            z-index: 1;
            pointer-events: none;
        }
        
        .suggestion-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 30px var(--shadow-color);
            border-color: var(--primary-color);
        }
        
        .suggestion-card:hover::before {
            width: 8px;
            box-shadow: 0 0 15px rgba(0, 80, 224, 0.4);
        }
        
        .suggestion-card:hover::after {
            opacity: 1;
            transform: translateX(0);
        }
        
        .suggestion-card p:first-child {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 17px;
            position: relative;
            padding-left: 12px;
            line-height: 1.4;
        }
        
        .suggestion-card p:first-child::before {
            content: '●';
            position: absolute;
            left: -2px;
            top: 1px;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        .suggestion-card:nth-child(even) p:first-child {
            color: var(--secondary-color);
        }
        
        .suggestion-card:nth-child(even) p:first-child::before {
            color: var(--secondary-color);
        }
        
        .suggestion-card p:last-child {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
        }
        
        /* 聊天消息 */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 25px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .message {
            display: flex;
            margin-bottom: 5px;
            animation: fadeInMessage 0.5s ease forwards;
            opacity: 0;
            position: relative;
        }
        
        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .assistant-avatar {
            background: var(--gradient-bg);
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0, 80, 224, 0.2);
        }
        
        .message-content {
            background-color: var(--card-bg);
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            flex: 1;
            position: relative;
            overflow: hidden;
            max-width: calc(100% - 70px);
        }
        
        .user-message .message-content {
            background-color: var(--user-msg-bg);
            border-top-left-radius: 4px;
        }
        
        .assistant-message .message-content {
            background-color: var(--assistant-msg-bg);
            border-top-right-radius: 4px;
            border-left: 4px solid var(--primary-light);
        }
        
        .message-text {
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
        }
        
        .user-message .message-text {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .assistant-message .message-text {
            color: var(--text-primary);
        }
        
        /* 流式打字效果 */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 18px;
            background-color: var(--primary-color);
            margin-left: 2px;
            animation: cursorBlink 0.8s infinite;
            vertical-align: middle;
        }
        
        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Markdown 样式增强 */
        .markdown-content {
            line-height: 1.7;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-weight: 600;
            line-height: 1.3;
            color: var(--primary-color);
        }
        
        .markdown-content h1 {
            font-size: 1.8em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        .markdown-content h2 {
            font-size: 1.6em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        .markdown-content h3 {
            font-size: 1.4em;
        }
        
        .markdown-content h4 {
            font-size: 1.2em;
        }
        
        .markdown-content h5 {
            font-size: 1em;
        }
        
        .markdown-content h6 {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        
        .markdown-content blockquote {
            padding: 0.5em 1em;
            margin: 0 0 1em 0;
            border-left: 4px solid var(--primary-light);
            background-color: rgba(0, 80, 224, 0.05);
            color: var(--text-secondary);
        }
        
        .markdown-content code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            background-color: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
            border: 1px solid var(--code-border);
        }
        
        .markdown-content pre {
            margin: 1em 0;
            padding: 1em;
            background-color: var(--code-bg);
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid var(--code-border);
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            border: none;
            font-size: 0.9em;
            display: block;
            line-height: 1.5;
        }
        
        .markdown-content a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        
        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid var(--border-color);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        
        .markdown-content table th {
            background-color: var(--primary-light);
            font-weight: 600;
        }
        
        .markdown-content table tr:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        .markdown-content img {
            max-width: 100%;
            margin: 1em 0;
            border-radius: 6px;
        }
        
        .markdown-content hr {
            height: 1px;
            background-color: var(--border-color);
            border: none;
            margin: 2em 0;
        }
        
        /* Mermaid 图表样式 */
        .mermaid {
            margin: 1.5em 0;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .mermaid svg {
            max-width: 100%;
        }
        
        /* 特定图表类型的样式调整 */
        .mermaid.gantt-chart {
            font-size: 14px;
        }
        
        .mermaid.pie-chart text {
            font-size: 14px !important;
            fill: var(--text-primary) !important;
        }
        
        .mermaid.flowchart .node rect,
        .mermaid.flowchart .node circle,
        .mermaid.flowchart .node ellipse,
        .mermaid.flowchart .node polygon,
        .mermaid.flowchart .node path {
            fill: var(--primary-light) !important;
            stroke: var(--primary-color) !important;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 10px;
            text-align: right;
        }
        
        .message-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .message-action-btn {
            background-color: transparent;
            border: none;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-action-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        .message-action-btn i {
            font-size: 16px;
        }
        
        /* 加载动画 */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: var(--loading-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            animation: loadingPulse 1.5s infinite alternate ease-in-out;
        }
        
        @keyframes loadingPulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dot-typing {
            position: relative;
            left: -9999px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 80, 224, 0.3);
            animation: dotTyping 1.2s infinite linear;
        }
        
        .dot-typing::before,
        .dot-typing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        
        .dot-typing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 80, 224, 0.3);
            animation: dotTyping 1.2s infinite linear;
            animation-delay: 0s;
        }
        
        .dot-typing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 80, 224, 0.3);
            animation: dotTyping 1.2s infinite linear;
            animation-delay: 0.4s;
        }
        
        @keyframes dotTyping {
            0% { transform: scale(1); opacity: 0.5; }
            25% { transform: scale(1.3); opacity: 1; }
            50% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        /* 底部输入框 */
        .chat-input-container {
            padding: 25px 100px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
            position: relative;
            z-index: 10;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chat-input-box {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            overflow: hidden;
            padding: 12px 20px;
            background-color: var(--light-bg);
            transition: all 0.3s ease;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chat-input-box:focus-within {
            border-color: var(--primary-color);
            box-shadow: var(--glow-effect);
            transform: translateY(-2px);
        }
        
        .input-options {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            margin-right: 15px;
        }
        
        .input-options i {
            margin-right: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .input-options i:hover {
            color: var(--primary-color);
            transform: scale(1.1);
            background-color: rgba(0, 80, 224, 0.1);
        }
        
        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px 0;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-primary);
        }
        
        .send-button {
            background: var(--gradient-bg);
            color: white;
            border: none;
            border-radius: 10px;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 3px 10px rgba(0, 80, 224, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .send-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .send-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            opacity: 0.5;
        }
        
        .send-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 80, 224, 0.4);
        }
        
        .send-button:active:not(:disabled) {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 80, 224, 0.3);
        }
        
        .send-button i {
            font-size: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* 功能标签 */
        .function-tags {
            display: flex;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .function-tag {
            display: flex;
            align-items: center;
            background-color: var(--primary-light);
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .function-tag:hover {
            background-color: rgba(0, 80, 224, 0.12);
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 80, 224, 0.15);
        }
        
        .function-tag i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 80, 224, 0.05);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 80, 224, 0.15);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 80, 224, 0.3);
        }
        
        /* 浮动元素 */
        .floating-element {
            position: absolute;
            border-radius: 50%;
            background-color: var(--primary-color);
            opacity: 0.05;
            pointer-events: none;
        }
        
        .el-dot {
            border-radius: 50%;
        }
        
        .el-circle {
            border: 1px solid var(--primary-color);
            background-color: transparent;
        }
        
        .el-square {
            border-radius: 4px;
            transform: rotate(45deg);
        }
        
        /* 图表提示框 */
        .charts-prompt {
            background-color: var(--primary-light);
            border-radius: 10px;
            padding: 15px 20px;
            margin: 20px 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .charts-prompt h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .charts-prompt code {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .charts-prompt ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .charts-prompt li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 科技背景装饰 -->
        <div class="tech-bg">
            <div class="tech-grid"></div>
            
            <!-- 浮动元素装饰 -->
            <div class="floating-element el-circle" style="top: 15%; left: 10%; width: 120px; height: 120px;"></div>
            <div class="floating-element el-circle" style="bottom: 25%; right: 12%; width: 150px; height: 150px;"></div>
            <div class="floating-element el-dot" style="top: 35%; right: 25%;"></div>
            <div class="floating-element el-dot" style="bottom: 30%; left: 20%;"></div>
            <div class="floating-element el-square" style="top: 65%; right: 35%;"></div>
            <div class="floating-element el-square" style="top: 20%; left: 35%;"></div>
        </div>
        
        <!-- 侧边栏 -->
        <div class="sidebar">
            <!-- 首页按钮 -->
            <div class="home-button" id="home-button">
                <i class="bi bi-house-door"></i>
                <span>首页</span>
            </div>
            
            <div class="sidebar-item active" id="chat-tab">
                <i class="bi bi-chat-dots-fill"></i>
                <span>聊天</span>
            </div>
            <div class="sidebar-item" id="knowledge-tab">
                <i class="bi bi-journal-text"></i>
                <span>知识库</span>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="header">
                <div class="title-container">
                    <img src="logo.png" alt="中科院自动化所logo" class="logo">
                    <div class="title">中科院自动化所（矿山垂类大模型）</div>
                </div>
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="DeepSeek搜索...">
                </div>
                <div class="user-options">
                    <div class="header-icon" id="charts-help">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <div class="header-icon" id="email-contact">
                        <i class="bi bi-envelope"></i>
                    </div>
                </div>
            </div>
            
            <!-- 聊天内容区 -->
            <div class="chat-container">
                <!-- 欢迎部分 -->
                <div class="welcome-section" id="welcome-section">
                    <div class="bot-avatar">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <h2>您好！我是中科院矿山大模型！</h2>
                    <p class="welcome-text">基于先进的人工智能技术，为矿山行业提供专业知识服务。我可以帮助您解答矿山安全生产、开采技术、设备维护等相关问题，提供精准的专业指导与解决方案。</p>
                    
                    <div class="action-links">
                        <a href="#" class="toggle-link">选一条问题</a>
                        <a href="#" class="more-link">更多功能</a>
                    </div>
                    
                    <div class="charts-prompt" style="max-width: 700px; margin: 40px auto 0;">
                        <h4><i class="bi bi-graph-up"></i> 图表功能已启用</h4>
                        <p>本系统现已支持各类图表绘制功能，只需在问题中要求使用图表，或在回答中使用以下语法：</p>
                        <ul>
                            <li><code>```mermaid</code> 开始一个图表代码块</li>
                            <li>支持流程图、甘特图、饼图、序列图等多种图表类型</li>
                            <li>例如：<code>gantt</code>、<code>pie</code>、<code>flowchart</code>、<code>sequenceDiagram</code></li>
                        </ul>
                        <p>请尝试发送："<a href="#" class="chart-example">绘制一个矿山开采项目进度甘特图</a>"</p>
                    </div>
                </div>
                
                <!-- 建议问题卡片 -->
                <div class="suggestions-container" id="suggestions-container">
                    <div class="suggestion-card">
                        <p>矿井通风系统设计与优化方案</p>
                        <p>如何优化矿井通风系统设计，提高通风效率和安全性？我需要了解风路设计原则和新型通风技术应用方案。</p>
                    </div>
                    <div class="suggestion-card">
                        <p>矿山顶板事故预防与监测技术</p>
                        <p>有哪些先进的矿山顶板监测技术和预防措施可以降低事故风险？特别是在复杂地质条件下的应用方案。</p>
                    </div>
                    <div class="suggestion-card">
                        <p>煤矿瓦斯治理与安全管控方法</p>
                        <p>如何有效进行煤矿瓦斯抽采和治理，构建完善的安全管控体系？请提供最新的瓦斯治理理念和技术手段。</p>
                    </div>
                    <div class="suggestion-card">
                        <p>煤矿智能化开采技术与应用</p>
                        <p>煤矿智能化开采技术的最新发展趋势和实际应用案例有哪些？特别是在无人化采掘和远程控制方面的突破。</p>
                    </div>
                </div>
                
                <!-- 聊天消息 -->
                <div class="chat-messages" id="chat-messages">
                    <!-- 消息将通过JS动态添加 -->
                </div>
            </div>
            
            <!-- 底部输入框 -->
            <div class="chat-input-container">
                <!-- 功能标签 -->
                <div class="function-tags">
                    <div class="function-tag" id="chart-flowchart">
                        <i class="bi bi-diagram-3"></i>
                        <span>流程图</span>
                    </div>
                    <div class="function-tag" id="chart-gantt">
                        <i class="bi bi-calendar4-week"></i>
                        <span>甘特图</span>
                    </div>
                    <div class="function-tag" id="chart-pie">
                        <i class="bi bi-pie-chart"></i>
                        <span>饼图</span>
                    </div>
                    <div class="function-tag" id="chart-sequence">
                        <i class="bi bi-arrow-down-up"></i>
                        <span>序列图</span>
                    </div>
                </div>
                
                <!-- 输入框 -->
                <div class="chat-input-box">
                    <div class="input-options">
                        <i class="bi bi-emoji-smile"></i>
                        <i class="bi bi-text-paragraph"></i>
                    </div>
                    <input type="text" class="chat-input" id="chat-input" placeholder="请输入您的矿山相关问题...">
                    <button class="send-button" id="send-button">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加 Markdown 和 Mermaid 解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.2.4/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 Mermaid
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default',
                securityLevel: 'loose',
                flowchart: { useMaxWidth: true, htmlLabels: true },
                gantt: { 
                    titleTopMargin: 25,
                    barHeight: 20,
                    barGap: 4,
                    topPadding: 50,
                    sidePadding: 50 
                }
            });
            
            // 固定的 API Key
            const apiKey = "sk-bbee92c6844c4ed3a9b30eb9864e9c99";
            let messages = [];
            let isProcessing = false;
            
            // 当前会话ID - 完全重写的关键解决方案
            let currentResponseId = null;
            
            // DOM 元素
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');
            const welcomeSection = document.getElementById('welcome-section');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const chatTab = document.getElementById('chat-tab');
            const knowledgeTab = document.getElementById('knowledge-tab');
            const homeButton = document.getElementById('home-button');
            const chartsHelp = document.getElementById('charts-help');
            const emailContact = document.getElementById('email-contact');
            
            // 图表类型按钮
            const chartFlowchart = document.getElementById('chart-flowchart');
            const chartGantt = document.getElementById('chart-gantt');
            const chartPie = document.getElementById('chart-pie');
            const chartSequence = document.getElementById('chart-sequence');
            
            // 图表示例链接
            const chartExample = document.querySelector('.chart-example');
            
            // 初始化 Marked - 添加 Mermaid 支持
            marked.setOptions({
                gfm: true, // GitHub 风格 Markdown
                breaks: true, // 允许换行符转换为 <br>
                headerIds: true, // 自动为标题生成 ID
                smartLists: true, // 更智能的列表行为
                highlight: function(code, lang) {
                    if (lang === 'mermaid') {
                        return `<div class="mermaid">${code}</div>`;
                    }
                    return code;
                }
            });
            
            // 初始化
            initializeInterface();
            
            // 初始化界面
            function initializeInterface() {
                // 首页/重置按钮点击事件
                homeButton.addEventListener('click', function() {
                    window.location.reload();
                });
                
                // 邮箱联系按钮
                emailContact.addEventListener('click', function() {
                    window.location.href = 'mailto:yiwei.ru@cripac.ia.ac.cn';
                });
                
                // 知识库按钮点击事件
                knowledgeTab.addEventListener('click', function() {
                    window.location.href = 'rag.html';
                });
                
                // 建议卡片点击事件
                const suggestionCards = document.querySelectorAll('.suggestion-card');
                suggestionCards.forEach(card => {
                    card.addEventListener('click', function() {
                        const questionText = this.querySelector('p:last-child').textContent;
                        chatInput.value = questionText;
                        chatInput.focus();
                        
                        // 高亮输入框
                        highlightInput();
                    });
                });
                
                // 图表示例点击事件
                chartExample.addEventListener('click', function(e) {
                    e.preventDefault();
                    chatInput.value = "绘制一个矿山开采项目进度甘特图";
                    chatInput.focus();
                    highlightInput();
                });
                
                // 图表类型按钮点击事件
                chartFlowchart.addEventListener('click', function() {
                    chatInput.value = "请以流程图展示煤矿安全生产流程";
                    chatInput.focus();
                    highlightInput();
                });
                
                chartGantt.addEventListener('click', function() {
                    chatInput.value = "请绘制一个矿山开采项目的甘特图进度表";
                    chatInput.focus();
                    highlightInput();
                });
                
                chartPie.addEventListener('click', function() {
                    chatInput.value = "用饼图展示中国不同类型矿产资源分布比例";
                    chatInput.focus();
                    highlightInput();
                });
                
                chartSequence.addEventListener('click', function() {
                    chatInput.value = "请用序列图说明矿井事故应急响应流程";
                    chatInput.focus();
                    highlightInput();
                });
                
                // 图表帮助按钮点击事件
                chartsHelp.addEventListener('click', function() {
                    addMessageToUI('assistant', `
## 图表功能使用指南

本系统支持多种图表类型，您可以通过以下方式使用图表功能：

### 流程图 (Flowchart)
适用于展示工作流、决策过程等：

\`\`\`mermaid
flowchart TD
    A[开始] --> B{是否安全?}
    B -->|是| C[开始采矿]
    B -->|否| D[安全检查]
    D --> B
    C --> E[结束]
\`\`\`

### 甘特图 (Gantt)
适用于项目进度管理：

\`\`\`mermaid
gantt
    title 矿山开发项目进度
    dateFormat  YYYY-MM-DD
    section 前期工作
    环境评估      :a1, 2023-01-01, 30d
    安全规划      :a2, after a1, 20d
    section 开采阶段
    设备安装      :b1, after a2, 25d
    试运行        :b2, after b1, 15d
    正式开采      :b3, after b2, 30d
\`\`\`

### 饼图 (Pie)
适用于展示比例关系：

\`\`\`mermaid
pie title 矿产资源分布占比
    "煤炭" : 45
    "铁矿" : 20
    "铜矿" : 15
    "黄金" : 10
    "其他" : 10
\`\`\`

### 序列图 (Sequence)
适用于展示不同角色间的交互：

\`\`\`mermaid
sequenceDiagram
    participant 监控中心
    participant 安全员
    participant 采矿设备
    监控中心->>安全员: 发送安全警报
    安全员->>采矿设备: 发送停机指令
    采矿设备-->>安全员: 确认停机
    安全员-->>监控中心: 报告情况
\`\`\`

您可以直接点击下方的图表类型按钮，或在问题中明确要求使用特定类型的图表。`, true);
                });
                
                // 发送按钮点击事件
                sendButton.addEventListener('click', handleSendMessage);
                
                // 回车键发送消息
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !isProcessing && chatInput.value.trim() !== '') {
                        handleSendMessage();
                    }
                });
                
                // 聊天标签点击事件
                chatTab.addEventListener('click', function() {
                    resetActiveTab();
                    chatTab.classList.add('active');
                });
                
                // 创建浮动元素
                for (let i = 0; i < 30; i++) {
                    createFloatingElement();
                }
                
                // 添加鼠标移动视差效果
                document.addEventListener('mousemove', handleMouseParallax);
            }
            
            // 发送消息处理
            function handleSendMessage() {
                if (isProcessing || chatInput.value.trim() === '') return;
                
                const userMessage = chatInput.value.trim();
                
                // 隐藏欢迎部分和建议卡片
                welcomeSection.classList.add('hidden');
                suggestionsContainer.style.display = 'none';
                
                // 添加用户消息到界面
                addMessageToUI('user', userMessage);
                
                // 清空输入框
                chatInput.value = '';
                
                // 添加消息到历史记录
                messages.push({ role: 'user', content: userMessage });
                
                // 准备接收流式响应 - 创建唯一响应ID
                const responseId = 'response-' + Date.now();
                currentResponseId = responseId;
                prepareForStreamedResponse(responseId);
                
                // 调用 DeepSeek API - 启用流式响应
                callDeepSeekAPIWithStreaming(messages, responseId);
            }
            
            // 为流式响应准备UI元素 - 修订版
            function prepareForStreamedResponse(responseId) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                
                // 创建新的助手消息容器，并使用唯一ID标识
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant-message';
                messageDiv.innerHTML = `
                    <div class="message-avatar assistant-avatar">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <div class="message-content">
                        <div class="markdown-content" id="${responseId}"></div>
                        <div class="message-time">${timeString}</div>
                        <div class="message-actions">
                            <button class="message-action-btn copy-btn" data-content="" data-response-id="${responseId}">
                                <i class="bi bi-clipboard"></i> 复制
                            </button>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                
                // 添加动画效果
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 10);
                
                // 获取对应输出区域并添加光标
                const responseElement = document.getElementById(responseId);
                responseElement.innerHTML = '<span class="typing-cursor"></span>';
                
                // 滚动到底部
                scrollToBottom();
                
                // 设置处理状态
                isProcessing = true;
                sendButton.disabled = true;
            }
            
            // 流式调用 DeepSeek API
            async function callDeepSeekAPIWithStreaming(messageHistory, responseId) {
                try {
                    // 如果在处理过程中请求已过期，则直接返回
                    if (responseId !== currentResponseId) {
                        console.log('请求已过期，终止处理');
                        return;
                    }
                    
                    // 创建安全的系统消息，告知模型使用 Markdown 格式和 Mermaid 图表
                    const systemMessage = {
                        role: 'system',
                        content: `You are a mining industry AI assistant developed by Chinese Academy of Sciences, specialized in coal mining safety, mining technology, and equipment maintenance. 

Format your responses using Markdown for better readability. Use proper headers, lists, tables, code blocks, etc. where appropriate.

You can also create diagrams using mermaid syntax when appropriate:

For flowcharts:
\`\`\`mermaid
flowchart TD
    A[开始] --> B{是否安全?}
    B -->|是| C[开始采矿]
    B -->|否| D[安全检查]
\`\`\`

For Gantt charts:
\`\`\`mermaid
gantt
    title 矿山开发项目进度
    dateFormat  YYYY-MM-DD
    section 前期工作
    环境评估      :a1, 2023-01-01, 30d
    安全规划      :a2, after a1, 20d
\`\`\`

For pie charts:
\`\`\`mermaid
pie title 矿产资源分布占比
    "煤炭" : 45
    "铁矿" : 20
    "铜矿" : 15
\`\`\`

For sequence diagrams:
\`\`\`mermaid
sequenceDiagram
    participant 监控中心
    participant 安全员
    监控中心->>安全员: 发送安全警报
\`\`\`

Use these diagrams when they help explain concepts, processes, or data, especially when the user specifically asks for visual representations.`
                    };
                    
                    // 净化消息历史记录以确保兼容性
                    const safeMessages = messageHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                    
                    // 准备请求体
                    const requestBody = {
                        model: 'deepseek-chat',
                        messages: [systemMessage, ...safeMessages],
                        stream: true
                    };
                    
                    // 发送请求
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || '调用 API 失败');
                    }
                    
                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let fullResponse = '';
                    let buffer = '';
                    
                    while (true) {
                        // 检查当前请求是否仍然是活动的
                        if (responseId !== currentResponseId) {
                            console.log('流式响应已过期，终止处理');
                            break;
                        }
                        
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        
                        // 处理缓冲区中的所有完整事件
                        let lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // 保留最后一个不完整的行
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            if (line.trim() === 'data: [DONE]') continue;
                            
                            try {
                                // 解析事件数据
                                if (line.startsWith('data: ')) {
                                    const jsonData = JSON.parse(line.substring(6));
                                    
                                    if (jsonData.choices && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
                                        const textChunk = jsonData.choices[0].delta.content;
                                        fullResponse += textChunk;
                                        
                                        // 更新UI中的文本，使用响应ID
                                        updateStreamingText(fullResponse, responseId);
                                    }
                                }
                            } catch (error) {
                                console.error('Stream parsing error:', error, line);
                            }
                        }
                    }
                    
                    // 处理最后可能残留的数据
                    if (buffer.trim() !== '' && responseId === currentResponseId) {
                        try {
                            if (buffer.startsWith('data: ') && buffer.trim() !== 'data: [DONE]') {
                                const jsonData = JSON.parse(buffer.substring(6));
                                
                                if (jsonData.choices && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
                                    const textChunk = jsonData.choices[0].delta.content;
                                    fullResponse += textChunk;
                                    
                                    // 更新UI中的文本
                                    updateStreamingText(fullResponse, responseId);
                                }
                            }
                        } catch (error) {
                            console.error('Final buffer parsing error:', error, buffer);
                        }
                    }
                    
                    // 完成流式响应
                    if (responseId === currentResponseId) {
                        finishStreamedResponse(fullResponse, responseId);
                        
                        // 添加消息到历史记录
                        messages.push({ role: 'assistant', content: fullResponse });
                    }
                    
                } catch (error) {
                    console.error('API 调用错误:', error);
                    
                    // 显示错误消息，使用响应ID
                    const responseElement = document.getElementById(responseId);
                    if (responseElement) {
                        responseElement.innerHTML = `⚠️ 出现错误: ${error.message}`;
                    }
                    
                } finally {
                    // 只有当这是当前活动的请求时才重置状态
                    if (responseId === currentResponseId) {
                        isProcessing = false;
                        sendButton.disabled = false;
                        currentResponseId = null;
                    }
                }
            }
            
            // 更新流式文本 - 修复版本
            function updateStreamingText(text, responseId) {
                // 获取对应的响应元素
                const responseElement = document.getElementById(responseId);
                if (responseElement) {
                    // 解析Markdown
                    responseElement.innerHTML = marked.parse(text) + '<span class="typing-cursor"></span>';
                    
                    // 更新复制按钮的数据
                    const copyBtn = document.querySelector(`.copy-btn[data-response-id="${responseId}"]`);
                    if (copyBtn) {
                        copyBtn.setAttribute('data-content', text);
                    }
                    
                    // 渲染任何Mermaid图表
                    try {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid:not([data-processed="true"])'));
                    } catch (error) {
                        // 忽略Mermaid初始化错误，可能是不完整的图表
                    }
                    
                    // 滚动到底部
                    scrollToBottom();
                }
            }
            
            // 完成流式响应
            function finishStreamedResponse(fullText, responseId) {
                // 获取对应的响应元素
                const responseElement = document.getElementById(responseId);
                if (responseElement) {
                    // 解析完整的Markdown
                    responseElement.innerHTML = marked.parse(fullText);
                    
                    // 更新复制按钮的数据和事件
                    const copyBtn = document.querySelector(`.copy-btn[data-response-id="${responseId}"]`);
                    if (copyBtn) {
                        copyBtn.setAttribute('data-content', fullText);
                        
                        // 添加复制功能
                        copyBtn.addEventListener('click', function() {
                            const content = this.getAttribute('data-content');
                            navigator.clipboard.writeText(content)
                                .then(() => {
                                    // 成功复制后的反馈
                                    copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> 已复制';
                                    setTimeout(() => {
                                        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> 复制';
                                    }, 2000);
                                })
                                .catch(err => {
                                    console.error('复制失败:', err);
                                });
                        });
                    }
                    
                    // 最终渲染Mermaid图表
                    try {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid:not([data-processed="true"])'));
                    } catch (error) {
                        console.error("Mermaid final initialization error:", error);
                    }
                    
                    // 滚动到底部
                    scrollToBottom();
                }
            }
            
            // 添加消息到界面（用于用户消息和非流式助手消息）
            function addMessageToUI(role, content, isMarkdown = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                
                // 格式化当前时间
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                
                // 设置头像图标
                const avatarIcon = role === 'user' ? 'bi-person-fill' : 'bi-cpu-fill';
                
                // 处理消息内容（支持 Markdown 和 Mermaid）
                let messageContent;
                if (isMarkdown && role === 'assistant') {
                    try {
                        // 使用 Marked 解析 Markdown
                        messageContent = `<div class="markdown-content">${marked.parse(content)}</div>`;
                    } catch (e) {
                        console.error("Markdown parsing error:", e);
                        messageContent = `<div class="message-text">${escapeHtml(content)}</div>`;
                    }
                } else {
                    // 普通文本（用户消息或非 Markdown 消息）
                    messageContent = `<div class="message-text">${escapeHtml(content)}</div>`;
                }
                
                // 设置消息 HTML
                messageDiv.innerHTML = `
                    <div class="message-avatar ${role}-avatar">
                        <i class="bi ${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        ${messageContent}
                        <div class="message-time">${timeString}</div>
                        ${role === 'assistant' ? `
                        <div class="message-actions">
                            <button class="message-action-btn copy-btn" data-content="${escapeHtml(content)}">
                                <i class="bi bi-clipboard"></i> 复制
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                
                // 渲染 Mermaid 图表
                if (isMarkdown) {
                    try {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid:not([data-processed="true"])'));
                    } catch (error) {
                        console.error("Mermaid initialization error:", error);
                    }
                }
                
                scrollToBottom();
                
                // 添加复制按钮事件
                if (role === 'assistant') {
                    const copyBtn = messageDiv.querySelector('.copy-btn');
                    copyBtn.addEventListener('click', function() {
                        const content = this.getAttribute('data-content');
                        navigator.clipboard.writeText(content)
                            .then(() => {
                                // 成功复制后的反馈
                                copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> 已复制';
                                setTimeout(() => {
                                    copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> 复制';
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('复制失败:', err);
                            });
                    });
                }
                
                // 添加动画效果
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 10);
            }
            
            // HTML 转义函数，防止 XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 滚动到底部
            function scrollToBottom() {
                const chatContainer = document.querySelector('.chat-container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 高亮输入框动画
            function highlightInput() {
                const chatInputBox = document.querySelector('.chat-input-box');
                chatInputBox.classList.add('highlight-border');
                setTimeout(() => {
                    chatInputBox.classList.remove('highlight-border');
                }, 1000);
            }
            
            // 重置侧边栏激活状态
            function resetActiveTab() {
                chatTab.classList.remove('active');
                knowledgeTab.classList.remove('active');
            }
            
            // 鼠标移动视差效果
            function handleMouseParallax(e) {
                const mouseX = e.clientX / window.innerWidth;
                const mouseY = e.clientY / window.innerHeight;
                
                const elements = document.querySelectorAll('.floating-element');
                elements.forEach(element => {
                    const offsetX = (mouseX - 0.5) * 20;
                    const offsetY = (mouseY - 0.5) * 20;
                    const depth = parseFloat(element.style.zIndex || 1) * 0.2;
                    
                    element.style.transform = `translate(${offsetX * depth}px, ${offsetY * depth}px) ${element.style.transform}`;
                });
                
                // 给卡片添加3D倾斜效果
                const cards = document.querySelectorAll('.suggestion-card');
                cards.forEach(card => {
                    if (!card.getBoundingClientRect) return;
                    
                    const cardRect = card.getBoundingClientRect();
                    const cardCenterX = cardRect.left + cardRect.width / 2;
                    const cardCenterY = cardRect.top + cardRect.height / 2;
                    
                    const rotateY = (e.clientX - cardCenterX) / 50;
                    const rotateX = (cardCenterY - e.clientY) / 50;
                    
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                });
            }
            
            // 创建浮动装饰元素
            function createFloatingElement() {
                const types = ['dot', 'circle', 'square'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                const element = document.createElement('div');
                element.classList.add('floating-element');
                
                // 随机位置
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                element.style.left = `${x}%`;
                element.style.top = `${y}%`;
                
                // 随机层级
                element.style.zIndex = Math.floor(Math.random() * 3) + 1;
                
                // 随机动画延迟
                element.style.animationDelay = `${Math.random() * 5}s`;
                
                switch(type) {
                    case 'dot':
                        element.classList.add('el-dot');
                        element.style.width = `${Math.random() * 4 + 2}px`;
                        element.style.height = element.style.width;
                        break;
                    case 'circle':
                        element.classList.add('el-circle');
                        const size = Math.random() * 60 + 20;
                        element.style.width = `${size}px`;
                        element.style.height = `${size}px`;
                        break;
                    case 'square':
                        element.classList.add('el-square');
                        const squareSize = Math.random() * 30 + 10;
                        element.style.width = `${squareSize}px`;
                        element.style.height = `${squareSize}px`;
                        break;
                }
                
                document.querySelector('.tech-bg').appendChild(element);
            }
            
            // 添加高亮输入框动画样式
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .highlight-border {
                    animation: highlightBorder 1s ease;
                }
                
                @keyframes highlightBorder {
                    0%, 100% { border-color: var(--border-color); }
                    50% { border-color: var(--primary-color); box-shadow: var(--glow-effect); }
                }
            `;
            document.head.appendChild(styleElement);
        });
    </script>
</body>
</html>
